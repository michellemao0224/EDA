Explore Loan Data by Lanmixue Mao (Michelle)
========================================================
```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Load all of the packages that you end up using in your analysis in this code
# chunk.

# Notice that the parameter "echo" was set to FALSE for this code chunk. This
# prevents the code from displaying in the knitted HTML output. You should set
# echo=FALSE for all code chunks in your file, unless it makes sense for your
# report to show the code that generated a particular plot.

# The other parameters for "message" and "warning" should also be set to FALSE
# for other code chunks once you have verified that each plot comes out as you
# want it to. This will clean up the flow of your report.

library(ggplot2)
library(reshape2)
library(GGally)
library(gridExtra)
library(scales)
library(memisc)
library(bitops)
library(RCurl)
library(dplyr)
library(tidyr)

```

```{r echo=FALSE, Load_the_Data}
# Load the Data
loan <- read.csv('prosperLoanData.csv')

```
*** 
The dataset is comprised of 81 variables and contains 113937 entries. The variable that are explored in the dataset are the following Term : Amount of month customers opted for loan

LoanStatus : Current status of the loan like chargedoff, completed, defauted etc…

EstimatedEffectiveYield : Yield of lenders from borrowers minus the processing fee and late fines

ProsperScore : Risk Factor score from 1 to 10. 10 being least risky

BorrowerAPR : The Borrower’s Annual Percentage Rate (APR) for the loan.

BorrowerRate : The Borrower’s interest rate for this loan.

ListingCategory..numeric. : Prosper rating for borrowers in numbers

EmploymentStatus : Current type of employment

Occupation : Occupation of borrower at the time of listing

EmploymentStatusDuration : How long the employee has been employed

IsBorrowerHomeowner : Does the borrower owns house at the time of listing (True & False)

ProsperRating..Alpha. : Prosper rating for borrowers in alphabets

IncomeVerifiable : If the income of the borrower is verifiable at the time of listing (True & False)

StatedMonthlyIncome : Monthly income of the borrower

MonthlyLoanPayment : Monthly loan payment amount

Recommendations : Recommendations the borrowers has at the time of listing

DebtToIncomeRatio : The debt to income ratio of the borrower at the time the credit profile was pulled.

LoanOriginalAmount : Original amount of the loan

LoanOriginationQuarter : Quarter of the month when loan was originated

A basic exploration of the datset would give the following information

***
```{r echo=FALSE, message=FALSE, warning=FALSE}

names(loan)
summary(loan)

```

> The prosper loan data can allow me to explore:
1) The difference in borrower APR, borrower rate and lender yield. 
This shows the difference about what the actual interest rate the borrower haven.
2) By examining the relationship between borrower income and loan payment, we can see how likely the borrower can repay a debt.
3) Other information: general borrower credit status, credit risk analysis.

# Univariate Plots Section

> Basic Loan Information

# By looking at the frequent plot, the majority of borrowers (over 80,000) nomally prefer the term of 36 years. Around 25,000 borrowers choose the term of 60 years. Very few borrower like to lend the loan in very short term.

```{r echo=FALSE, Univariate_Plots}
# check which term borrower perfer to have the loan
qplot(x = Term, data = loan,
      xlab = 'Term (years)',
      ylab = 'Loan Count',
      main = 'How long borrower lend the loan',
      binwidth = 12, fill= I('#FF6EB4')) +
  scale_x_continuous(lim = c(0, 72), breaks = seq(0, 72, 12))

```

# From the histogram, over 75000 people choose the loan term in 36 years, much higher than 60 years. However, we can see not many people choose the year of term in 12 years.

```{r echo=FALSE, Univariate_Plots}
summary(loan$Term)
```

# We can see that people normally lend the loan around 4,000, also 10,000 and 15,000 are also the popular loan amount for borrowers. This frequency plot is positively skewed but appeared small peaks in every 5,000.

```{r echo=FALSE, Univariate_Plots}

qplot(x = LoanOriginalAmount, data = loan,
      binwidth = 1000, 
      xlab = 'Loan Original Amount',
      ylab = 'Count',
      main = 'How much loan borrower lend',
      colour = I('#FCFCFC'), fill= I('#FF6EB4')) +
  scale_x_continuous(breaks = seq(0, 35000, 5000))

```

> Basic Borrower Information

# Now let's dive into basic borrower info!

```{r echo=FALSE, Univariate_Plots}

qplot(x = IsBorrowerHomeowner, data = subset(loan, !is.na(ProsperScore)),
      xlab = 'Home Owner',
      ylab = 'Count',
      main = 'Number of Home Owner Borrower') +
  geom_histogram(stat='count', fill= I('#FF82AB'), color='white')

```

# Over half borrowers are home owner which shows the most of the loan borrower has strong debt paying ability.

```{r echo=FALSE, Univariate_Plots}

qplot(x = ProsperRating..Alpha., data = subset(loan, !is.na(ProsperScore)),
      xlab = 'Prosper Rating',
      ylab = 'Count',
      main = 'Prosper Rating of Borrower') +
  geom_histogram(stat='count', fill= I('#FF82AB'), color='white')+
  scale_x_discrete(limits = c('AA', 'A', 'B', 'C', 'D', 'E', 'HR'))

```

# Except for empty values, the distribution of the ordinal variable has a bell-like shape. ‘C’ is the most frequent rating in our data and the highest (AA) and the lowest (HR) rating are less common comparing with other ratings in between. 

Missing values are surprisingly high. After done the research, I found the Prosper Rating only exists after July 2009. Cross-validated from the loan original date, our data approved my assumption.

```{r echo=FALSE, Univariate_Plots}

ggplot(aes(x = reorder(Occupation, Occupation, 
                       function(x) - length(x)),
           fill = I("#FF82AB")), data = subset(loan,!is.na(Occupation))) +
  geom_bar() +
  xlab('Occupation of Borrower')  +
  ggtitle('What is borrower occupation') +
  coord_flip() +
  theme_bw() +
  theme(axis.text = element_text(size = 8))

```

# Apart from other occupations, professional occupies a large part of the count. Why bank and loan providers prefer to lend the loan to professional? The reason behind is they have stable and high income compared to others whilst they work on more techniqual job, which show the strong debt paying ability.

```{r echo=FALSE, Univariate_Plots}

ggplot(aes(x=reorder(IncomeRange,IncomeRange,
                     function(x)-length(x)),
           fill = I("#FF82AB")), 
       data = subset(loan, IncomeRange != '$0' & IncomeRange != 'Not displayed')) + 
  geom_bar() +
  xlab('Income Range')  +
  ylab('Count') +
  ggtitle('Income Range of Borrower') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

# From income perspective, we can see most borrower's income range is $25,000 - 49,999, the second top is the income range $50,000 - 74,999. This can explain that most people who has an income range $25,000 - 49,999 is the new graduate or young professional, they have a very strong buying power to purchase their first home or car.

```{r echo=FALSE, Univariate_Plots}

loan$AnnualIncome <- loan$StatedMonthlyIncome * 12
ggplot(aes(x = AnnualIncome), data = loan) +
  geom_histogram(fill= I('#FF82AB'), color='white') +
  scale_x_log10() +
  scale_x_continuous(lim = c(0, 150000), breaks = seq(0, 150000, 5000)) +
  xlab('Annual Income')  +
  ylab('Count') +
  ggtitle('Annual Income of Borrower') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

# Further, we look at the anuual income of the borrower, this positive skewed frequency plot shows the result as same as the frequency income range plot and repeatively confirms the strong buying power coming from young professionals.  

```{r echo=FALSE, Univariate_Plots}

ggplot(aes(x = BorrowerState), data = loan) +
  geom_histogram(aes(color = EmploymentStatus), stat="count", fill = 'white') +
  xlab('Borrower State')  +
  ylab('Count') +
  ggtitle('Number of Borrower in Each State') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

# We also care about which state has most borrower. The highest number of borrower is in CA, and it demonstrates that the California consumers have some of the higest levels of debt in the country. Moreover, the following Texas, New York and Florida can also be seen as a big loan market.

> Credit History

```{r echo=FALSE, Univariate_Plots}

ggplot(aes(x = CurrentDelinquencies), data = loan) +
  geom_histogram(fill= I('#E066FF'), color='white') +
  scale_x_continuous(lim = c(0, 16), breaks = seq(0, 16, 1)) +
  ylim(0, 12000) +
  xlab('Current Delinquency Times')  +
  ylab('Count') +
  ggtitle('How many times of current delinquency')

```

# Large proportion of borrowers only occurs one delinquency record. It normally because they forget to pay the annual fee for the credit card, or because they forget to repay one month loan.

```{r echo=FALSE, Univariate_Plots}

c1 <- ggplot(aes(x = DelinquenciesLast7Years), data = loan) +
  geom_histogram(fill= I('#E066FF'), color='white') +
  scale_x_continuous(lim = c(0, 40), breaks = seq(0, 40, 1)) +
  ylim(0, 7000) +
  xlab('Delinquency Last 7 Years')  +
  ylab('Count') +
  ggtitle('How many times of delinquency last 7 years')

c2 <- ggplot(aes(x = PublicRecordsLast10Years), data = loan) +
  geom_histogram(fill= I('#E066FF'), color='white') +
  scale_x_continuous(lim = c(0, 5), breaks = seq(0, 5, 1)) +
  ylim(0, 25000) +
  xlab('Public Delinquency Records Last 10 Years')  +
  ylab('Count') +
  ggtitle('How many times of public delinquency records last 10 years')

grid.arrange(c1, c2, nrow = 2)

```

# By checking the delinquency records last 7 years and public delinquency records last 10 years, it appears that having one delinquency records still the highest. But it's strange to see few borrowers have more than 30 times delinquencies.

```{r echo=FALSE, Univariate_Plots}

ggplot(aes(x = BankcardUtilization), data = subset(loan, !is.na(BankcardUtilization))) +
  geom_histogram(fill= I('#E066FF'), color='white') +
  scale_x_continuous(lim = c(0, 1.4), breaks = seq(0, 1.4, 0.2)) +
  ylim(0, 8000) +
  xlab('Bank Card Utilization')  +
  ylab('Count') +
  ggtitle('How many times the borrower use the bank card')

```

# Then how often the borrower use their bank card?
We can see the majority bank card utilization frequency is over 0.5 and reach the peak at the 0.9.
This can fully demonstrate how much borrower adore the bank card.

```{r echo=FALSE, Univariate_Plots}

ggplot(aes(x = TradesNeverDelinquent..percentage.), 
       data = subset(loan, !is.na(TradesNeverDelinquent..percentage.))) +
  geom_histogram(fill= I('#E066FF'), color='white') +
  scale_x_continuous(lim = c(0.3, 1.0), breaks = seq(0.3, 1.0, 0.05)) +
  ylim(0, 10000) +
  xlab('Trade Never Delinquent (percentage)')  +
  ylab('Count') +
  ggtitle('How many trades never delinquent')

```

# From the records of never delinquent trade, we can tell from this negative skewed histogram that most borrowers keep themselves having a good credit rating and value the lend money. Only few of them has a percentage below 0.50 that we can base on this record to select our loan borrowers and decide whether we want to deal with loan repayment with them or not.

```{r echo=FALSE, Univariate_Plots}

ggplot(aes(x = DebtToIncomeRatio), data = subset(loan, !is.na( DebtToIncomeRatio))) +
  geom_histogram(fill= I('#E066FF'), color='white') +
  scale_x_continuous(lim = c(0, 1.0), breaks = seq(0, 1.0, 0.05)) +
  ylim(0, 15000) +
  xlab('Ratio of Debt and Income')  +
  ylab('Count') +
  ggtitle('What is the ratio of debt and income')

```

# We also want to know how much debt burden that our borrower carry. The distribution of this frequency plot shows that the majority of borrower has a debt and income ratio less than 0.40. The ratio reaches the peak at 0.20. The borrowers's income can fully cover their debts, and it also obey the rule of "ratio of debt and income should 0.85 or 0.8".

# Univariate Analysis

> **Tip**: Now that you've completed your univariate explorations, it's time to
reflect on and summarize what you've found. Use the questions below to help you
gather your observations and add your own if you have other thoughts!

### What is the structure of your dataset?
The structure of the dataset covers the different loan interest rates, borrower's employment status and income, liability ratio, delinquency records, etc.

### What is/are the main feature(s) of interest in your dataset?
Main Features:
1) Interest Rate: BorrowerAPR, BorrowerRate, LendYield
2) Credit Rating: ProsperRating..Alpha., ProsperScore
3) Loan Status: Term, LoanOriginalAmount, BorrowerState, LoanOriginationQuarter
4) Borrower Profile: IncomeRange, DebtToIncomeRatio, EmploymentStatus, MonthlyLoanPayment
5) Delinquency Record: CurrentDelinquencies, DelinquenciesLast7Years, PublicRecordsLast12Months

### What other features in the dataset do you think will help support your \
investigation into your feature(s) of interest?
1) LP_CustomerPayments, LP_CustomerPrincipalPayments, LP_InterestandFees, LP_ServicesFees
Supporting to find how much profit the bank or loan providers can gain
2) IsBorrowerHomeOwner, Occupation
Supporting to find borrower's income source

### Did you create any new variables from existing variables in the dataset?
Created the annual income by calculating the stated monthly income

### Of the features you investigated, were there any unusual distributions? \
Did you perform any operations on the data to tidy, adjust, or change the form \
of the data? If so, why did you do this?
I cleaned the income range data, because the not displayed income or null value will affect to see the percentage of each income range.
I also excluded several missing values in few variables, such as: DebtToIncomeRatio, BankCardUtilization.

# Bivariate Plots Section

> **Tip**: Based on what you saw in the univariate plots, what relationships
between variables might be interesting to look at in this section? Don't limit
yourself to relationships between a main output feature and one of the
supporting variables. Try to look at relationships between supporting variables
as well.

# From univariate analysis, I had a big picture about my dataset. In this section, I try to analyse the relationships between variables.  My main focus will still on:
1. Customer Quality
2. Bank Profitability
3. Credit Risk

> Customer Quality

# Let us take a closer look at our borrowers.

```{r echo=FALSE, Bivariate_Plots}

ggplot(aes(x = LoanOriginationQuarter, y = LoanOriginalAmount), 
       data = subset(loan, !is.na(LoanOriginalAmount))) +
  geom_point(stat = "summary", fun.y = mean, color = '#FF6EB4') +
  scale_x_discrete(limits = c('Q1 2006','Q2 2006','Q3 2006','Q4 2006','Q1 2007','Q2 2007','Q3 2007','Q4 2007','Q1 2008','Q2 2008','Q3 2008','Q4 2008','Q2 2009','Q3 2009','Q4 2009','Q1 2010','Q2 2010','Q3 2010','Q4 2010','Q1 2011','Q2 2011','Q3 2011','Q4 2011','Q1 2012','Q2 2012','Q3 2012','Q4 2012','Q1 2013','Q2 2013','Q3 2013','Q4 2013','Q1 2014')) +
  xlab('Quarter')  +
  ylab('Loan Original Amount') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

```

```{r echo=FALSE, Bivariate_Plots}

ggplot(aes(x = IncomeRange, y = DebtToIncomeRatio), 
       data = subset(loan, !is.na(DebtToIncomeRatio))) +
  geom_boxplot(fill='#FF6EB4', color='#EEE685',
               outlier.colour = '#FF6EB4', outlier.shape = 4, outlier.size = 0.8) +
  scale_x_discrete(limits = c('$1-24,999', '$25,000-49,999', '$50,000-74,999', '$75,000-99,999', '$100,000+')) +
  scale_y_continuous(trans = log10_trans()) +
  xlab('Income Range')  +
  ylab('Debt to Income Ratio') 

```

```{r echo=FALSE, Bivariate_Plots}

m1 <- ggplot(aes(x = StatedMonthlyIncome, y = MonthlyLoanPayment / 100), data = loan) +
  geom_line(color = '#FF6EB4') +
  geom_smooth(color = '#EEE685') +
  scale_y_continuous(trans = log10_trans()) +
  xlim(0, 50000) +
  ylim(0.01, 1.5)+
  xlab('Monthly Income')  +
  ylab('Monthly Loan Payment') 

m2 <- ggplot(aes(x = StatedMonthlyIncome, y = DebtToIncomeRatio), data = loan) +
  geom_line(color = '#FF6EB4') +
  geom_smooth(color = '#EEE685') +
  scale_y_continuous(trans = log10_trans()) +
  xlim(0, 50000) +
  ylim(0.01, 1.5)+
  xlab('Monthly Income')  +
  ylab('Debt To Income Ratio') 

grid.arrange(m1, m2, nrow = 2)

```

```{r echo=FALSE, Bivariate_Plots}

ggplot(aes(x = ProsperRating..Alpha., y = BorrowerState), data = loan) +
  geom_point(aes(color = EmploymentStatus), size = 1.5) +
  scale_x_discrete(limits = c('AA', 'A', 'B', 'C', 'D', 'E', 'HR')) +
  xlab('Propser Rating')  +
  ylab('State') 

```

```{r echo=FALSE, Bivariate_Plots}

ggplot(aes(x = TotalTrades, y = BankcardUtilization), 
       data = subset(loan, !is.na(TotalTrades))) +
  geom_line(color = '#FF6EB4') +
  geom_smooth(color = '#EEE685') +
  scale_y_continuous(trans = log10_trans()) +
  xlab('Total Trades')  +
  ylab('Bank Card Utilization') 

```

> Bank Profitability

```{r echo=FALSE, Bivariate_Plots}

p1 <- ggplot(aes(x = ProsperRating..Alpha., y = BorrowerAPR), 
       data = loan) +
  geom_boxplot(aes(fill = ProsperRating..Alpha.)) +
  xlab('Prosper Rating')  +
  ylab('Borrower APR') +
  scale_x_discrete(limits = c('AA', 'A', 'B', 'C', 'D', 'E', 'HR'))

p2 <- ggplot(aes(x = ProsperRating..Alpha., y = BorrowerRate), 
       data = loan) +
  geom_boxplot(aes(fill = ProsperRating..Alpha.)) +
  xlab('Prosper Rating')  +
  ylab('Borrower Rate') +
  scale_x_discrete(limits = c('AA', 'A', 'B', 'C', 'D', 'E', 'HR'))

p3 <- ggplot(aes(x = ProsperRating..Alpha., y = LenderYield), 
       data = loan) +
  geom_boxplot(aes(fill = ProsperRating..Alpha.)) +
  xlab('Prosper Rating')  +
  ylab('Lender Yield') +
  scale_x_discrete(limits = c('AA', 'A', 'B', 'C', 'D', 'E', 'HR'))

grid.arrange(p1, p2, p3, nrow = 3)

```

```{r echo=FALSE, Bivariate_Plots}

ggplot(aes(x = LoanOriginationQuarter, y = LP_InterestandFees), 
       data = loan) +
  geom_point(stat = "summary", fun.y = mean, color = '#FF6EB4') +
  xlab('Quarter')  +
  ylab('Interest and Fees') +
  scale_x_discrete(limits = c('Q1 2006','Q2 2006','Q3 2006','Q4 2006','Q1 2007','Q2 2007','Q3 2007','Q4 2007','Q1 2008','Q2 2008','Q3 2008','Q4 2008','Q2 2009','Q3 2009','Q4 2009','Q1 2010','Q2 2010','Q3 2010','Q4 2010','Q1 2011','Q2 2011','Q3 2011','Q4 2011','Q1 2012','Q2 2012','Q3 2012','Q4 2012','Q1 2013','Q2 2013','Q3 2013','Q4 2013','Q1 2014')) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

```

```{r echo=FALSE, Bivariate_Plots}

ggplot(aes(x = EstimatedReturn, y = EstimatedLoss), 
       data = subset(loan, !is.na(EstimatedLoss))) +
  geom_line(aes(color = ProsperRating..Alpha.)) +
  xlab('Estimated Loss')  +
  ylab('Estimated Return') 

```

> Credit Risk

```{r echo=FALSE, Bivariate_Plots}

b1 <- ggplot(aes(x = BorrowerAPR, y = CurrentDelinquencies), 
       data = subset(loan, !is.na(CurrentDelinquencies))) +
  geom_point(alpha = 1/10, position = position_jitter(h = 0), color = I('#D02090'), size = 0.8) +
  xlab('Current Delinquencies')  +
  ylab('Borrower APR')

b2 <- ggplot(aes(x = BorrowerRate, y = CurrentDelinquencies), 
       data = subset(loan, !is.na(CurrentDelinquencies))) +
  geom_point(alpha = 1/10, position = position_jitter(h = 0), color = I('#D02090'), size = 0.8) +
  xlab('Current Delinquencies')  +
  ylab('Borrower Rate')

b3 <- ggplot(aes(x = LenderYield, y = CurrentDelinquencies), 
       data = subset(loan, !is.na(CurrentDelinquencies))) +
  geom_point(alpha = 1/10, position = position_jitter(h = 0), color = I('#D02090'), size = 0.8) +
  xlab('Current Delinquencies')  +
  ylab('Lender Yield') 

grid.arrange(b1, b2, b3, nrow = 3)

``` 

```{r echo=FALSE, Bivariate_Plots}

ggplot(aes(x = DebtToIncomeRatio, y = CurrentDelinquencies), 
       data = subset(loan, !is.na(CurrentDelinquencies))) +
  geom_point(color = I('#FF6EB4'), size = 0.8) +
  geom_smooth(method = 'lm', color = '#EEE685', size = 0.5) +
  xlab('Current Delinquencies')  +
  ylab('Debt to Income Ratio')

```

# Bivariate Analysis

> **Tip**: As before, summarize what you found in your bivariate explorations
here. Use the questions below to guide your discussion.

### Talk about some of the relationships you observed in this part of the \
investigation. How did the feature(s) of interest vary with other features in \
the dataset?

### Did you observe any interesting relationships between the other features \
(not the main feature(s) of interest)?

### What was the strongest relationship you found?


# Multivariate Plots Section

> **Tip**: Now it's time to put everything together. Based on what you found in
the bivariate plots section, create a few multivariate plots to investigate
more complex interactions between variables. Make sure that the plots that you
create here are justified by the plots you explored in the previous section. If
you plan on creating any mathematical models, this is the section where you
will do that.

```{r echo=FALSE, Multivariate_Plots}
loan.di_by_income_rate <- loan %>%
  filter(!is.na(ProsperRating..Alpha.)) %>%
  group_by(IncomeRange, ProsperRating..Alpha.) %>%
  summarise(mean_BorrowerAPR = mean(BorrowerAPR),
            median_BorrowerAPR = median(BorrowerAPR),
            n = n()) %>%
  ungroup() %>%
  arrange(IncomeRange)
head(loan.di_by_income_rate, 50)

ggplot(aes(x = IncomeRange, y = median_BorrowerAPR),
       data = subset(loan.di_by_income_rate, !is.na(IncomeRange) & IncomeRange != 'Not displayed')) +
  geom_point(aes(color = ProsperRating..Alpha.)) +
  xlab('Income Range') +
  ylab('Median Borrower APR') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 


```

```{r echo=FALSE, Multivariate_Plots}
loan.di_by_income_rate.wide <- dcast(loan.di_by_income_rate,
                                  IncomeRange ~ ProsperRating..Alpha.,
                                  value.val = 'median_BorrowerAPR')

loan.di_by_income_rate.wide <-
  subset(loan.di_by_income_rate[c('IncomeRange', 'ProsperRating..Alpha.', 'median_BorrowerAPR')],
         !is.na(ProsperRating..Alpha.)) %>%
  spread(ProsperRating..Alpha., median_BorrowerAPR) %>%
  mutate(ratio = AA / A)

head(loan.di_by_income_rate.wide)

pr1 <- ggplot(aes(x = IncomeRange, y = AA / A), 
       data = subset(loan.di_by_income_rate.wide, !is.na(IncomeRange) & IncomeRange != 'Not displayed')) +
  geom_point(color = '#FF0000') +
  geom_hline(yintercept = 0.7, alpha = 0.3, linetype = 2) +
  scale_x_discrete(
    limits = c('Not employed', '$1-24,999', '$25,000-49,999', '$50,000-74,999', '$75,000-99,999', '$100,000+')) +
  xlab('Income Range') +
  ylab('Ratio: AA / A ') +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) 

loan.di_by_income_rate.wide <-
  subset(loan.di_by_income_rate[c('IncomeRange', 'ProsperRating..Alpha.', 'median_BorrowerAPR')],
         !is.na(ProsperRating..Alpha.)) %>%
  spread(ProsperRating..Alpha., median_BorrowerAPR) %>%
  mutate(ratio = A / B)

pr2 <- ggplot(aes(x = IncomeRange, y = A / B), 
       data = subset(loan.di_by_income_rate.wide, !is.na(IncomeRange) & IncomeRange != 'Not displayed')) +
  geom_point(color = '#FF1493') +
  geom_hline(yintercept = 0.75, alpha = 0.3, linetype = 2) +
  scale_x_discrete(
    limits = c('Not employed', '$1-24,999', '$25,000-49,999', '$50,000-74,999', '$75,000-99,999', '$100,000+')) +
  xlab('Income Range') +
  ylab('Ratio:A / B ') +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) 

loan.di_by_income_rate.wide <-
  subset(loan.di_by_income_rate[c('IncomeRange', 'ProsperRating..Alpha.', 'median_BorrowerAPR')],
         !is.na(ProsperRating..Alpha.)) %>%
  spread(ProsperRating..Alpha., median_BorrowerAPR) %>%
  mutate(ratio = B / C)

pr3 <- ggplot(aes(x = IncomeRange, y = B / C), 
       data = subset(loan.di_by_income_rate.wide, !is.na(IncomeRange) & IncomeRange != 'Not displayed')) +
  geom_point(color = '#EEEE00') +
  geom_hline(yintercept = 0.8, alpha = 0.3, linetype = 2) +
  scale_x_discrete(
    limits = c('Not employed', '$1-24,999', '$25,000-49,999', '$50,000-74,999', '$75,000-99,999', '$100,000+')) +
  xlab('Income Range') +
  ylab('Ratio: B / C ') +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) 

loan.di_by_income_rate.wide <-
  subset(loan.di_by_income_rate[c('IncomeRange', 'ProsperRating..Alpha.', 'median_BorrowerAPR')],
         !is.na(ProsperRating..Alpha.)) %>%
  spread(ProsperRating..Alpha., median_BorrowerAPR) %>%
  mutate(ratio = C / D)

pr4 <- ggplot(aes(x = IncomeRange, y = C / D), 
       data = subset(loan.di_by_income_rate.wide, !is.na(IncomeRange) & IncomeRange != 'Not displayed')) +
  geom_point(color = '#66CD00') +
  geom_hline(yintercept = 0.8, alpha = 0.3, linetype = 2) +
  scale_x_discrete(
    limits = c('Not employed', '$1-24,999', '$25,000-49,999', '$50,000-74,999', '$75,000-99,999', '$100,000+')) +
  xlab('Income Range') +
  ylab('Ratio: C / D ') +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) 

loan.di_by_income_rate.wide <-
  subset(loan.di_by_income_rate[c('IncomeRange', 'ProsperRating..Alpha.', 'median_BorrowerAPR')],
         !is.na(ProsperRating..Alpha.)) %>%
  spread(ProsperRating..Alpha., median_BorrowerAPR) %>%
  mutate(ratio = D / E)

pr5 <- ggplot(aes(x = IncomeRange, y = D / E), 
       data = subset(loan.di_by_income_rate.wide, !is.na(IncomeRange) & IncomeRange != 'Not displayed')) +
  geom_point(color = '#5CACEE') +
  geom_hline(yintercept = 0.85, alpha = 0.3, linetype = 2) +
  scale_x_discrete(
    limits = c('Not employed', '$1-24,999', '$25,000-49,999', '$50,000-74,999', '$75,000-99,999', '$100,000+')) +
  xlab('Income Range') +
  ylab('Ratio: D / E ') +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) 

loan.di_by_income_rate.wide <-
  subset(loan.di_by_income_rate[c('IncomeRange', 'ProsperRating..Alpha.', 'median_BorrowerAPR')],
         !is.na(ProsperRating..Alpha.)) %>%
  spread(ProsperRating..Alpha., median_BorrowerAPR) %>%
  mutate(ratio = E / HR)

pr6 <- ggplot(aes(x = IncomeRange, y = E / HR), 
       data = subset(loan.di_by_income_rate.wide, !is.na(IncomeRange) & IncomeRange != 'Not displayed')) +
  geom_point(color = '#9A32CD') +
  geom_hline(yintercept = 0.95, alpha = 0.3, linetype = 2) +
  scale_x_discrete(
    limits = c('Not employed', '$1-24,999', '$25,000-49,999', '$50,000-74,999', '$75,000-99,999', '$100,000+')) +
  xlab('Income Range') +
  ylab('Ratio: E / HR ') +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

grid.arrange(pr1, pr2, pr3, pr4, pr5, pr6, ncol = 2)
```

```{r echo=FALSE, Multivariate_Plots}
loan.amount_by_state_yield <- loan %>%
  filter(!is.na(BorrowerState)) %>%
  group_by(LoanOriginalAmount, BorrowerState) %>%
  summarise(mean_LenderYield = mean(LenderYield),
            median_LenderYield = median(LenderYield),
            n = n()) %>%
  ungroup() %>%
  arrange(LoanOriginalAmount)
head(loan.amount_by_state_yield, 50)

ggplot(aes(x = BorrowerState, y = median_LenderYield),
       data = subset(loan.amount_by_state_yield, !is.na(BorrowerState))) +
  geom_point(aes(color = LoanOriginalAmount), size = 1.5) +
  ylim(0, 0.35) +
  xlab('Borrower State') +
  ylab('Median Lender Yield') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) 
```
#  the super high-interest loans have boomed in California.
```{r echo=FALSE, Multivariate_Plots}
loan.di_by_income_delienquncy <- loan %>%
  filter(!is.na(DebtToIncomeRatio)) %>%
  group_by(IncomeRange, DebtToIncomeRatio) %>%
  summarise(mean_CurrentDelinquencies = mean(CurrentDelinquencies),
            n = n()) %>%
  ungroup() %>%
  arrange(IncomeRange)
head(loan.di_by_income_delienquncy, 50)

ggplot(aes(x = IncomeRange, y = mean_CurrentDelinquencies),
       data = subset(loan.di_by_income_delienquncy, !is.na(IncomeRange) & IncomeRange != 'Not displayed')) +
  geom_point(aes(color = DebtToIncomeRatio), size = 1.5) +
  scale_y_continuous(trans = log10_trans()) +
  scale_x_discrete(
    limits = c('Not employed', '$1-24,999', '$25,000-49,999', '$50,000-74,999', '$75,000-99,999', '$100,000+')) +
  xlab('Income Range') +
  ylab('Average Current Delinquencies') +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) 
```

# Multivariate Analysis

### Talk about some of the relationships you observed in this part of the \
investigation. Were there features that strengthened each other in terms of \
looking at your feature(s) of interest?

### Were there any interesting or surprising interactions between features?

### OPTIONAL: Did you create any models with your dataset? Discuss the \
strengths and limitations of your model.

------

# Final Plots and Summary

> **Tip**: You've done a lot of exploration and have built up an understanding
of the structure of and relationships between the variables in your dataset.
Here, you will select three plots from all of your previous exploration to
present here as a summary of some of your most interesting findings. Make sure
that you have refined your selected plots for good titling, axis labels (with
units), and good aesthetic choices (e.g. color, transparency). After each plot,
make sure you justify why you chose each plot by describing what it shows.

### Plot One
```{r echo=FALSE, Plot_One}
loan.income_by_amount <- loan %>%
  filter(!is.na(IncomeRange)) %>%
  group_by(IncomeRange) %>%
  summarise(mean_LoanOriginalAmount = mean(LoanOriginalAmount),
            n = n()) %>%
  ungroup() %>%
  arrange(IncomeRange)
head(loan.income_by_amount, 50)

ggplot(aes(x = IncomeRange, y = mean_LoanOriginalAmount),
       data = subset(loan.income_by_amount, !is.na(IncomeRange))) +
  geom_point(color = '#B22222', size = 2) +
  scale_x_discrete(
    limits = c('Not employed', '$1-24,999', '$25,000-49,999', '$50,000-74,999', '$75,000-99,999', '$100,000+')) +
  xlab('Income Range') +
  ylab('Average Loan Original Amount') +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) 

```

### Description One
Customer Quality

### Plot Two
```{r echo=FALSE, Plot_Two}
loan.apr_by_income <- loan %>%
  filter(!is.na(LoanOriginalAmount)) %>%
  group_by(LoanOriginalAmount, ProsperRating..Alpha.) %>%
  summarise(mean_BorrowerAPR = mean(BorrowerAPR),
            n = n()) %>%
  ungroup() %>%
  arrange(LoanOriginalAmount)
head(loan.apr_by_income, 50)

pro1 <- ggplot(aes(x = LoanOriginalAmount, y = mean_BorrowerAPR),
       data = subset(loan.apr_by_income, !is.na(mean_BorrowerAPR))) +
  geom_point(aes(color = ProsperRating..Alpha.)) +
  xlab('Loan Original Amount') +
  ylab('Average Borrower APR') 

loan.rate_by_income <- loan %>%
  filter(!is.na(LoanOriginalAmount)) %>%
  group_by(LoanOriginalAmount, ProsperRating..Alpha.) %>%
  summarise(mean_BorrowerRate = mean(BorrowerRate),
            n = n()) %>%
  ungroup() %>%
  arrange(LoanOriginalAmount)

pro2 <- ggplot(aes(x = LoanOriginalAmount, y = mean_BorrowerRate),
       data = subset(loan.rate_by_income, !is.na(mean_BorrowerRate))) +
  geom_point(aes(color = ProsperRating..Alpha.)) +
  xlab('Loan Original Amount') +
  ylab('Average Borrower Rate')

loan.yield_by_income <- loan %>%
  filter(!is.na(LoanOriginalAmount)) %>%
  group_by(LoanOriginalAmount, ProsperRating..Alpha.) %>%
  summarise(mean_LenderYield = mean(LenderYield),
            n = n()) %>%
  ungroup() %>%
  arrange(LoanOriginalAmount)

pro3 <- ggplot(aes(x = LoanOriginalAmount, y = mean_LenderYield),
       data = subset(loan.yield_by_income, !is.na(mean_LenderYield))) +
  geom_point(aes(color = ProsperRating..Alpha.)) +
  xlab('Loan Original Amount') +
  ylab('Average Lender Yield') 

grid.arrange(pro1, pro2, pro3, ncol = 1)

```

### Description Two
Bank Profitability

### Plot Three
```{r echo=FALSE, Plot_Three}
loan.loss_by_rate_delienquncy <- loan %>%
  filter(!is.na(EstimatedLoss)) %>%
  group_by(ProsperRating..Alpha., EstimatedLoss) %>%
  summarise(mean_CurrentDelinquencies = mean(CurrentDelinquencies),
            n = n()) %>%
  ungroup() %>%
  arrange(ProsperRating..Alpha.)
head(loan.loss_by_rate_delienquncy, 50)

ggplot(aes(x = ProsperRating..Alpha., y = mean_CurrentDelinquencies),
       data = subset(loan.loss_by_rate_delienquncy, !is.na(ProsperRating..Alpha.))) +
  geom_point(aes(color = EstimatedLoss), size = 1.5) +
  scale_x_discrete(limits = c('AA', 'A', 'B', 'C', 'D', 'E', 'HR')) +
  xlab('Prosper Rating') +
  ylab('Average Current Delinquencies') 
```

### Description Three
Credit Risk
------

# Reflection

> **Tip**: Here's the final step! Reflect on the exploration you performed and
the insights you found. What were some of the struggles that you went through?
What went well? What was surprising? Make sure you include an insight into
future work that could be done with the dataset.

> **Tip**: Don't forget to remove this, and the other **Tip** sections before
saving your final work and knitting the final report!